---
- name: "Ubuntu custom - GNOME + ZSH + X11 + Dark mode + Flameshot + Docker + Exegold + tmux + VirtualBox + delayed reboot"
  hosts: localhost
  become: false
  gather_facts: true

  vars:
    user_home: "{{ ansible_env.HOME }}"
    zshrc_path: "{{ user_home }}/.zshrc"
    omz_dir: "{{ user_home }}/.oh-my-zsh"
    exegold_dir: "{{ user_home }}/Exegold"
    exegold_venv: "{{ exegold_dir }}/venv"
    terminal_colors_file: "{{ user_home }}/terminal-colors.dconf"  # Fichier d'export des couleurs

  handlers:
    - name: reboot_system
      become: true
      ansible.builtin.command: shutdown -r +1 "Redémarrage pour appliquer les changements (X11, Docker, etc.)"
      async: 1
      poll: 0

  tasks:
    # ======================
    # DBUS (pour gsettings)
    # ======================
    - name: "Récupérer l'UID utilisateur"
      ansible.builtin.command: id -u
      register: uid_cmd
      changed_when: false
      tags: [always]

    - name: "Définir DBUS_SESSION_BUS_ADDRESS"
      ansible.builtin.set_fact:
        dbus_addr: "unix:path=/run/user/{{ uid_cmd.stdout }}/bus"
      tags: [always]

    # ======================
    # Forcer X11 (désactiver Wayland)
    # ======================
    - name: "Forcer X11 (WaylandEnable=false)"
      become: true
      ansible.builtin.lineinfile:
        path: /etc/gdm3/custom.conf
        regexp: '^\s*#?\s*WaylandEnable='
        line: 'WaylandEnable=false'
        create: true
        backup: true
      notify: reboot_system
      tags: [system, x11]

    # ======================
    # GNOME – Dark Mode
    # ======================
    - name: "Activer le dark mode GNOME"
      ansible.builtin.command: gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'
      environment:
        DBUS_SESSION_BUS_ADDRESS: "{{ dbus_addr }}"
      failed_when: false
      changed_when: false
      tags: [gnome, appearance]

    - name: "Forcer thème GTK sombre"
      ansible.builtin.command: gsettings set org.gnome.desktop.interface gtk-theme 'Yaru-dark'
      environment:
        DBUS_SESSION_BUS_ADDRESS: "{{ dbus_addr }}"
      failed_when: false
      changed_when: false
      tags: [gnome, appearance]

    # ======================
    # GNOME Terminal – Couleurs personnalisées
    # ======================
    - name: "Créer un nouveau profil terminal perso"
      ansible.builtin.shell: |
        PROFILE_ID="12cb3421-ab18-45fc-b08a-f5ad3b883a35"
        PROFILE_PATH="/org/gnome/terminal/legacy/profiles:/:$PROFILE_ID"
        
        # Ajouter le profil à la liste s'il n'existe pas
        current_list=$(dconf read /org/gnome/terminal/legacy/profiles:/list)
        if [[ ! "$current_list" =~ "$PROFILE_ID" ]]; then
          if [ "$current_list" = "@as []" ] || [ -z "$current_list" ]; then
            dconf write /org/gnome/terminal/legacy/profiles:/list "['$PROFILE_ID']"
          else
            new_list=$(echo "$current_list" | sed "s/]$/, '$PROFILE_ID']/")
            dconf write /org/gnome/terminal/legacy/profiles:/list "$new_list"
          fi
        fi
        
        # Définir comme profil par défaut
        dconf write /org/gnome/terminal/legacy/profiles:/default "'$PROFILE_ID'"
        
        # Appliquer les couleurs
        dconf write $PROFILE_PATH/visible-name "'perso'"
        dconf write $PROFILE_PATH/use-theme-colors "false"
        dconf write $PROFILE_PATH/use-theme-transparency "false"
        dconf write $PROFILE_PATH/use-transparent-background "false"
        dconf write $PROFILE_PATH/scroll-on-output "false"
        dconf write $PROFILE_PATH/scrollback-unlimited "true"
        dconf write $PROFILE_PATH/background-color "'rgb(0,0,0)'"
        dconf write $PROFILE_PATH/foreground-color "'rgb(255,255,255)'"
        dconf write $PROFILE_PATH/palette "['rgb(0,0,0)', 'rgb(255,0,0)', 'rgb(0,205,0)', 'rgb(205,205,0)', 'rgb(0,182,205)', 'rgb(205,0,205)', 'rgb(0,205,205)', 'rgb(250,235,215)', 'rgb(64,64,64)', 'rgb(255,0,0)', 'rgb(0,255,0)', 'rgb(255,255,0)', 'rgb(0,177,255)', 'rgb(195,79,79)', 'rgb(0,255,255)', 'rgb(255,255,255)']"
      args:
        executable: /bin/bash
      environment:
        DBUS_SESSION_BUS_ADDRESS: "{{ dbus_addr }}"
      changed_when: false
      tags: [gnome, terminal]

    # ======================
    # GNOME Terminal – Couleurs personnalisées
    # ======================
    - name: "Vérifier si le fichier de couleurs existe"
      ansible.builtin.stat:
        path: "{{ terminal_colors_file }}"
      register: terminal_colors_stat
      tags: [gnome, terminal]

    - name: "Importer les couleurs du terminal"
      ansible.builtin.shell: |
        dconf load /org/gnome/terminal/legacy/profiles:/ < {{ terminal_colors_file }}
      environment:
        DBUS_SESSION_BUS_ADDRESS: "{{ dbus_addr }}"
      when: terminal_colors_stat.stat.exists
      changed_when: false
      tags: [gnome, terminal]

    - name: "Afficher un message si le fichier de couleurs est absent"
      ansible.builtin.debug:
        msg: "Fichier {{ terminal_colors_file }} non trouvé. Couleurs par défaut conservées."
      when: not terminal_colors_stat.stat.exists
      tags: [gnome, terminal]

    # ======================
    # GNOME – Dock
    # ======================
    - name: "Mettre le dock en bas"
      ansible.builtin.command: gsettings set org.gnome.shell.extensions.dash-to-dock dock-position 'BOTTOM'
      environment:
        DBUS_SESSION_BUS_ADDRESS: "{{ dbus_addr }}"
      failed_when: false
      changed_when: false
      tags: [gnome, dock]

    - name: "Mettre Show Apps en haut du dock"
      ansible.builtin.command: gsettings set org.gnome.shell.extensions.dash-to-dock show-apps-at-top true
      environment:
        DBUS_SESSION_BUS_ADDRESS: "{{ dbus_addr }}"
      failed_when: false
      changed_when: false
      tags: [gnome, dock]

    # ======================
    # APT – Google Chrome + VirtualBox + upgrade + paquets
    # ======================
    - name: "Ajouter clé Google Chrome"
      become: true
      ansible.builtin.get_url:
        url: https://dl.google.com/linux/linux_signing_key.pub
        dest: /etc/apt/trusted.gpg.d/google.asc
        mode: "0644"
      tags: [apt, chrome]

    - name: "Ajouter dépôt Google Chrome"
      become: true
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64] https://dl.google.com/linux/chrome/deb/ stable main"
        filename: google-chrome
        update_cache: true
      tags: [apt, chrome]

    - name: "Ajouter clé Mullvad VPN"
      become: true
      ansible.builtin.get_url:
        url: https://repository.mullvad.net/deb/mullvad-keyring.asc
        dest: /usr/share/keyrings/mullvad-keyring.asc
        mode: "0644"
      tags: [apt, mullvad]

    - name: "Ajouter dépôt Mullvad VPN"
      become: true
      ansible.builtin.shell: |
        echo "deb [signed-by=/usr/share/keyrings/mullvad-keyring.asc arch=$(dpkg --print-architecture)] https://repository.mullvad.net/deb/stable stable main" | tee /etc/apt/sources.list.d/mullvad.list
      args:
        executable: /bin/bash
        creates: /etc/apt/sources.list.d/mullvad.list
      tags: [apt, mullvad]

    - name: "Ajouter dépôt VirtualBox (trusted)"
      become: true
      ansible.builtin.apt_repository:
        repo: "deb [trusted=yes] https://download.virtualbox.org/virtualbox/debian oracular contrib"
        filename: virtualbox
        update_cache: true
      tags: [apt, virtualbox]

    - name: "Full upgrade système"
      become: true
      ansible.builtin.apt:
        upgrade: full
        update_cache: true
      tags: [apt, upgrade]

    - name: "Mettre à jour le cache APT pour Mullvad"
      become: true
      ansible.builtin.apt:
        update_cache: true
      tags: [apt, mullvad]

    - name: "Installer paquets système (incluant VirtualBox 7.2)"
      become: true
      ansible.builtin.apt:
        name:
          - tar
          - bzip2
          - ansible
          - libreoffice
          - libreoffice-l10n-fr
          - libreoffice-help-fr
          - hunspell-fr
          - hyphen-fr
          - mythes-fr
          - openfortivpn
          - obs-studio
          - python3-pip
          - python3.12-venv
          - curl
          - git
          - zsh
          - fzf
          - tmux
          - flameshot
          - cherrytree
          - rpi-imager
          - google-chrome-stable
          - mullvad-vpn
          - virtualbox-7.2
        state: present
        update_cache: true
      tags: [apt, packages]

    # ======================
    # Docker
    # ======================
    - name: "Vérifier si Docker est installé"
      ansible.builtin.command: docker --version
      register: docker_check
      failed_when: false
      changed_when: false
      tags: [docker]

    - name: "Installer Docker (get.docker.com)"
      become: true
      ansible.builtin.shell: curl -fsSL https://get.docker.com/ | sh
      args:
        executable: /bin/bash
      when: docker_check.rc != 0
      notify: reboot_system
      tags: [docker]

    - name: "Ajouter l'utilisateur au groupe docker"
      become: true
      ansible.builtin.user:
        name: "{{ ansible_user_id }}"
        groups: docker
        append: true
      notify: reboot_system
      tags: [docker]

    # ======================
    # VeraCrypt
    # ======================
    - name: "Télécharger VeraCrypt .deb"
      ansible.builtin.get_url:
        url: https://launchpad.net/veracrypt/trunk/1.26.24/+download/veracrypt-1.26.24-Ubuntu-24.04-amd64.deb
        dest: /tmp/veracrypt.deb
        mode: "0644"
      tags: [veracrypt]

    - name: "Installer VeraCrypt"
      become: true
      ansible.builtin.apt:
        deb: /tmp/veracrypt.deb
        state: present
      tags: [veracrypt]

    - name: "Nettoyer le fichier .deb VeraCrypt"
      ansible.builtin.file:
        path: /tmp/veracrypt.deb
        state: absent
      tags: [veracrypt]

    # ======================
    # Balena Etcher
    # ======================
    - name: "Télécharger Balena Etcher .deb"
      ansible.builtin.get_url:
        url: https://github.com/balena-io/etcher/releases/download/v2.1.4/balena-etcher_2.1.4_amd64.deb
        dest: /tmp/balena-etcher.deb
        mode: "0644"
      tags: [etcher]

    - name: "Installer Balena Etcher"
      become: true
      ansible.builtin.apt:
        deb: /tmp/balena-etcher.deb
        state: present
      tags: [etcher]

    - name: "Nettoyer le fichier .deb Balena Etcher"
      ansible.builtin.file:
        path: /tmp/balena-etcher.deb
        state: absent
      tags: [etcher]

    # ======================
    # ZSH / Oh My Zsh
    # ======================
    - name: "Définir zsh comme shell par défaut"
      become: true
      ansible.builtin.user:
        name: "{{ ansible_user_id }}"
        shell: /usr/bin/zsh
      tags: [zsh]

    - name: "Vérifier Oh My Zsh"
      ansible.builtin.stat:
        path: "{{ omz_dir }}"
      register: omz_stat
      tags: [zsh]

    - name: "Installer Oh My Zsh"
      ansible.builtin.shell: |
        RUNZSH=no CHSH=no KEEP_ZSHRC=yes \
        sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
      args:
        executable: /bin/bash
      when: not omz_stat.stat.exists
      tags: [zsh]

    - name: "Forcer le thème gentoo"
      ansible.builtin.lineinfile:
        path: "{{ zshrc_path }}"
        regexp: '^ZSH_THEME='
        line: 'ZSH_THEME="gentoo"'
        create: true
      tags: [zsh]

    # ======================
    # Oh My Zsh – Plugins
    # ======================
    - name: "Installer plugins ZSH"
      ansible.builtin.git:
        repo: "{{ item.repo }}"
        dest: "{{ user_home }}/.oh-my-zsh/custom/plugins/{{ item.name }}"
        depth: 1
        update: true
      loop:
        - { name: zsh-syntax-highlighting, repo: https://github.com/zsh-users/zsh-syntax-highlighting.git }
        - { name: zsh-completions, repo: https://github.com/zsh-users/zsh-completions.git }
        - { name: zsh-autosuggestions, repo: https://github.com/zsh-users/zsh-autosuggestions.git }
        - { name: zsh-z, repo: https://github.com/agkozak/zsh-z.git }
        - { name: zsh-nvm, repo: https://github.com/lukechilds/zsh-nvm.git }
      tags: [zsh, plugins]

    - name: "Ajouter zsh-completions au fpath"
      ansible.builtin.blockinfile:
        path: "{{ zshrc_path }}"
        marker: "# {mark} ANSIBLE ZSH COMPLETIONS"
        insertbefore: '^source \$ZSH/oh-my-zsh\.sh'
        block: |
          fpath+=${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins/zsh-completions/src
      tags: [zsh, plugins]

    - name: "Configurer plugins ZSH"
      ansible.builtin.lineinfile:
        path: "{{ zshrc_path }}"
        regexp: '^plugins='
        line: 'plugins=(zsh-syntax-highlighting zsh-completions zsh-autosuggestions tmux fzf zsh-z zsh-nvm)'
        create: true
      tags: [zsh, plugins]

    # ======================
    # Flameshot – Print Screen
    # ======================
    - name: "Désactiver screenshot GNOME natif"
      ansible.builtin.command: gsettings set org.gnome.shell.keybindings show-screenshot-ui "[]"
      environment:
        DBUS_SESSION_BUS_ADDRESS: "{{ dbus_addr }}"
      failed_when: false
      changed_when: false
      tags: [gnome, flameshot]

    - name: "Binder Print Screen sur Flameshot"
      ansible.builtin.shell: |
        BASE="/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings"
        PATHF="$BASE/flameshot/"
        current=$(gsettings get org.gnome.settings-daemon.plugins.media-keys custom-keybindings | sed 's/@as //')
        if [ "$current" = "[]" ]; then
          new="['$PATHF']"
        else
          echo "$current" | grep -q "$PATHF" && new="$current" || new="$(echo "$current" | sed "s/]$/, '$PATHF']/")"
        fi
        gsettings set org.gnome.settings-daemon.plugins.media-keys custom-keybindings "$new"
        gsettings set org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:$PATHF name 'Flameshot'
        gsettings set org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:$PATHF command 'flameshot gui'
        gsettings set org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:$PATHF binding 'Print'
      args:
        executable: /bin/bash
      environment:
        DBUS_SESSION_BUS_ADDRESS: "{{ dbus_addr }}"
      changed_when: false
      tags: [gnome, flameshot]

    # ======================
    # Exegold
    # ======================
    - name: "Cloner Exegold"
      ansible.builtin.git:
        repo: https://github.com/fsoc106/Exegold
        dest: "{{ exegold_dir }}"
        update: true
      tags: [exegold]

    - name: "Créer venv pour Exegold"
      ansible.builtin.command: python3 -m venv {{ exegold_venv }}
      args:
        creates: "{{ exegold_venv }}"
      tags: [exegold]

    - name: "Installer requirements Exegold dans venv"
      ansible.builtin.pip:
        requirements: "{{ exegold_dir }}/requirements.txt"
        virtualenv: "{{ exegold_venv }}"
      tags: [exegold]

    - name: "Créer script wrapper exegol"
      become: true
      ansible.builtin.copy:
        dest: /usr/local/bin/exegol
        mode: "0755"
        content: |
          #!/bin/bash
          {{ exegold_venv }}/bin/python {{ exegold_dir }}/exegol.py "$@"
      tags: [exegold]

    # ======================
    # Attente + Reboot
    # ======================
    - name: "Forcer le reboot si nécessaire"
      ansible.builtin.meta: flush_handlers
      tags: [reboot]

    - name: "Attendre confirmation avant reboot"
      ansible.builtin.pause:
        prompt: "Le système va redémarrer dans 1 minute. Appuyez sur Entrée pour continuer ou Ctrl+C puis 'A' pour annuler le reboot"
      tags: [reboot]

    - name: "Message final"
      ansible.builtin.debug:
        msg: "Configuration terminée ! Le système redémarrera dans 1 minute si des changements l'exigent."
      tags: [reboot]
